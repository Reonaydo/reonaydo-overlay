From 1e089e3abd270f86f6a00b66e608cd837c8e6430 Mon Sep 17 00:00:00 2001
From: Poncho <poncho@spahan.ch>
Date: Mon, 7 Sep 2020 09:39:49 +0200
Subject: [PATCH 1/6] Fix building with bison 3.7

Bison 3.7 changes how header files are included [1][2], in that instead of
copying and inserting the contents of a file, the file itself is included
(by default as '"basename.h"').

[1] https://lists.gnu.org/archive/html/info-gnu/2020-07/msg00006.html
[2] https://www.gnu.org/software/bison/manual/html_node/_0025define-Summary.html

Close: https://github.com/GoldenCheetah/GoldenCheetah/issues/3586
---
 src/Core/DataFilter.y     | 3 +++
 src/Core/RideDB.y         | 2 ++
 src/FileIO/JsonRideFile.y | 3 +++
 3 files changed, 8 insertions(+)

diff --git a/src/Core/DataFilter.y b/src/Core/DataFilter.y
index c532c06ee2..3d4e914ee3 100644
--- a/src/Core/DataFilter.y
+++ b/src/Core/DataFilter.y
@@ -49,6 +49,9 @@ extern Leaf *DataFilterroot; // root node for parsed statement
 
 %}
 
+// generated by the scanner
+%define api.header.include {"DataFilter_yacc.h"}
+
 // Symbol can be meta or metric name
 %token <leaf> SYMBOL PYTHON
 
diff --git a/src/Core/RideDB.y b/src/Core/RideDB.y
index e2b63cc0dd..86f8a2ec94 100644
--- a/src/Core/RideDB.y
+++ b/src/Core/RideDB.y
@@ -40,6 +40,8 @@ void RideDBerror(void*jc, const char *error) // used by parser aka yyerror()
 #define scanner jc->scanner
 
 %}
+// generated by the scanner
+%define api.header.include {"RideDB_yacc.h"}
 
 %pure-parser
 %lex-param { void *scanner }
diff --git a/src/FileIO/JsonRideFile.y b/src/FileIO/JsonRideFile.y
index 2cbbef9fc8..d5c77a779d 100644
--- a/src/FileIO/JsonRideFile.y
+++ b/src/FileIO/JsonRideFile.y
@@ -106,6 +106,9 @@ static QString protect(const QString string)
 
 %}
 
+// generated by the scanner
+%define api.header.include {"JsonRideFile_yacc.h"}
+
 %pure-parser
 %lex-param { void *scanner }
 %parse-param { struct JsonContext *jc }

From 7f741a9c775e9d651e9d5a1d9565f3b77b6c6c8a Mon Sep 17 00:00:00 2001
From: Poncho <poncho@spahan.ch>
Date: Sun, 11 Oct 2020 11:27:43 +0200
Subject: [PATCH 2/6] require >=bison-3.4

Unfortunately, the "%define api.header.include" synthax is not compatible with
older versions of bison [1]

[1] https://lists.gnu.org/archive/html/bug-bison/2020-08/msg00014.html
[skip travis] [skip appveyor]
---
 src/Core/DataFilter.y     | 1 +
 src/Core/RideDB.y         | 2 ++
 src/FileIO/JsonRideFile.y | 1 +
 3 files changed, 4 insertions(+)

diff --git a/src/Core/DataFilter.y b/src/Core/DataFilter.y
index 3d4e914ee3..08f1716a65 100644
--- a/src/Core/DataFilter.y
+++ b/src/Core/DataFilter.y
@@ -49,6 +49,7 @@ extern Leaf *DataFilterroot; // root node for parsed statement
 
 %}
 
+%require "3.4"
 // generated by the scanner
 %define api.header.include {"DataFilter_yacc.h"}
 
diff --git a/src/Core/RideDB.y b/src/Core/RideDB.y
index 86f8a2ec94..7427e36062 100644
--- a/src/Core/RideDB.y
+++ b/src/Core/RideDB.y
@@ -40,6 +40,8 @@ void RideDBerror(void*jc, const char *error) // used by parser aka yyerror()
 #define scanner jc->scanner
 
 %}
+
+%require "3.4"
 // generated by the scanner
 %define api.header.include {"RideDB_yacc.h"}
 
diff --git a/src/FileIO/JsonRideFile.y b/src/FileIO/JsonRideFile.y
index d5c77a779d..c5e6b8e774 100644
--- a/src/FileIO/JsonRideFile.y
+++ b/src/FileIO/JsonRideFile.y
@@ -106,6 +106,7 @@ static QString protect(const QString string)
 
 %}
 
+%require "3.4"
 // generated by the scanner
 %define api.header.include {"JsonRideFile_yacc.h"}
 

From 18471a420d70fd6f9299ff1d89d0d433d8e23e8b Mon Sep 17 00:00:00 2001
From: Florian Klink <flokli@flokli.de>
Date: Sun, 11 Oct 2020 17:10:56 +0200
Subject: [PATCH 3/6] *.y: update comment regarding bison versioning

We never verified this works with plain old yacc, and probably it
doesn't anymore.
---
 src/Core/DataFilter.y     | 13 ++++++-------
 src/FileIO/JsonRideFile.y | 14 +++++++-------
 2 files changed, 13 insertions(+), 14 deletions(-)

diff --git a/src/Core/DataFilter.y b/src/Core/DataFilter.y
index 08f1716a65..53f35882f6 100644
--- a/src/Core/DataFilter.y
+++ b/src/Core/DataFilter.y
@@ -17,13 +17,12 @@
  * Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
  */
 
-// This grammar should work with yacc and bison, but has
-// only been tested with bison. In addition, since qmake
-// uses the -p flag to rename all the yy functions to
-// enable multiple grammars in a single executable you
-// should make sure you use the very latest bison since it
-// has been known to be problematic in the past. It is
-// know to work well with bison v2.4.1.
+// This grammar is only tested to work with bison >=3.4
+// In addition, since qmake uses the -p flag to rename
+// all the yy functions to enable multiple grammars in
+// a single executable you should make sure you use the
+// very latest bison since it has been known to be
+// problematic in the past.
 //
 // To make the grammar readable I have placed the code
 // for each nterm at column 40, this source file is best
diff --git a/src/FileIO/JsonRideFile.y b/src/FileIO/JsonRideFile.y
index c5e6b8e774..ddd330e204 100644
--- a/src/FileIO/JsonRideFile.y
+++ b/src/FileIO/JsonRideFile.y
@@ -17,13 +17,13 @@
  * Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
  */
 
-// This grammar should work with yacc and bison, but has
-// only been tested with bison. In addition, since qmake
-// uses the -p flag to rename all the yy functions to
-// enable multiple grammars in a single executable you
-// should make sure you use the very latest bison since it
-// has been known to be problematic in the past. It is
-// know to work well with bison v2.4.1.
+
+// This grammar is only tested to work with bison >=3.4
+// In addition, since qmake uses the -p flag to rename
+// all the yy functions to enable multiple grammars in
+// a single executable you should make sure you use the
+// very latest bison since it has been known to be
+// problematic in the past.
 //
 // To make the grammar readable I have placed the code
 // for each nterm at column 40, this source file is best

From 1db88824ccf54cf1506901abc7a7b94374728864 Mon Sep 17 00:00:00 2001
From: Florian Klink <flokli@flokli.de>
Date: Sun, 11 Oct 2020 17:11:48 +0200
Subject: [PATCH 4/6] ci: osx: install bison 3.7 using homebrew

The one provided by Xcode is too old.
Also update installation instructions.
---
 INSTALL-MAC                  | 1 +
 travis/osx/before_install.sh | 1 +
 travis/osx/before_script.sh  | 2 ++
 3 files changed, 4 insertions(+)

diff --git a/INSTALL-MAC b/INSTALL-MAC
index 23eb45cf8f..4a77bc6bbe 100644
--- a/INSTALL-MAC
+++ b/INSTALL-MAC
@@ -25,6 +25,7 @@ CONTENTS
 1. BASIC INSTALLATION WITH MANDATORY DEPENDENCIES
    - Xcode
    - Qt
+   - bison >= 2.4
 
 2. ADDING OPTIONAL DEPENDENCIES
    - FTDI D2XX
diff --git a/travis/osx/before_install.sh b/travis/osx/before_install.sh
index 9e84825635..f4fe8d0985 100755
--- a/travis/osx/before_install.sh
+++ b/travis/osx/before_install.sh
@@ -12,6 +12,7 @@ brew unlink python@2 # to avoid conflicts with qt/libical dependence on python
 /usr/local/opt/qt5/bin/qmake --version
 
 brew install gsl
+brew install bison
 brew install libical
 brew upgrade libusb
 brew install srmio
diff --git a/travis/osx/before_script.sh b/travis/osx/before_script.sh
index f6558fb95d..4dfda9cad6 100755
--- a/travis/osx/before_script.sh
+++ b/travis/osx/before_script.sh
@@ -31,6 +31,8 @@ sed -i "" "s|#\(QMAKE_CXXFLAGS\).*|\1_RELEASE += -mmacosx-version-min=10.7 -arch
 sed -i "" "s|^#CloudDB|CloudDB|" src/gcconfig.pri
 sed -i "" "s|^#LIBZ|LIBZ|" src/gcconfig.pri
 sed -i "" "s|#\(SRMIO_INSTALL =.*\)|\1 /usr/local|" src/gcconfig.pri
+# Bison/YACC
+echo QMAKE_YACC=/usr/local/opt/bison/bin/yacc >> src/gcconfig.pri
 # D2XX
 sed -i "" "s|libftd2xx.dylib|@executable_path/../Frameworks/libftd2xx.1.2.2.dylib|" src/FileIO/D2XX.cpp
 sed -i "" "s|#\(D2XX_INCLUDE =.*\)|\1 ../D2XX|" src/gcconfig.pri

From c3eaa4f6a902b1af3160560d494304a298b1713f Mon Sep 17 00:00:00 2001
From: Florian Klink <flokli@flokli.de>
Date: Sun, 11 Oct 2020 17:21:12 +0200
Subject: [PATCH 5/6] ci: windows: install winflexbison3

---
 INSTALL-WIN32 | 11 ++++-------
 appveyor.yml  | 12 ++++++++++++
 2 files changed, 16 insertions(+), 7 deletions(-)

diff --git a/INSTALL-WIN32 b/INSTALL-WIN32
index 343e513a4f..6bb48cc0cb 100644
--- a/INSTALL-WIN32
+++ b/INSTALL-WIN32
@@ -46,13 +46,10 @@ You need:
   -- When installing the SDK you have several options - for GoldenCheetah you need the "SDK" itself and
      in case you want to Debug also the "Debugging Tools" to be installed. All other parts (to my experience)
 	 are not required.
-	 
-- Flex and Bison (below the version working for me)
-  -- Download from here: https://sourceforge.net/projects/winflexbison/
-  -- Use the "win_flex_bison-latest.zip" version
-  -- Unzip whereever you like and make sure that the location "win_bison.exe" and "win_flex.exe
-     are added to your "Path" environment variable
-	 
+
+- Flex and Bison (bison 3.7.1, flex 2.6.4 seem to work)
+  -- Use `choco install winflexbison3`
+
 - Qt C++ Framework
   -- As of today, please use Qt 5.8.0 (which is the most recent official release) for Microsoft VC2015
   -- Download is available here: https://www.qt.io/download/ - the OpenSource version is sufficient
diff --git a/appveyor.yml b/appveyor.yml
index 996e59d023..c83f2b212f 100644
--- a/appveyor.yml
+++ b/appveyor.yml
@@ -59,6 +59,13 @@ install:
 # Get the libraries
 - if not exist gc-ci-libs.zip appveyor DownloadFile "https://github.com/GoldenCheetah/WindowsSDK/releases/download/v0.1.1/gc-ci-libs.zip"
 - 7z x -y gc-ci-libs.zip -oC:\libs
+# TODO: remove bison and flex from the archive instead of removing it after extraction
+- ps: Remove-Item C:\libs\win_bison.exe
+- ps: Remove-Item C:\libs\win_flex.exe
+- ps: Remove-Item C:\libs\bison.yacc
+- ps: Remove-Item C:\libs\custom_build_rules/*
+# winflexbison3 (not available in vcpkg)
+- choco install winflexbison3
 # GSL
 - vcpkg install gsl:x64-windows
 
@@ -122,6 +129,11 @@ before_build:
 # Add Train Robot
 - echo DEFINES+=GC_WANT_ROBOT >> src\gcconfig.pri
 
+# Override QMAKE_LEX and QMAKE_YACC coming from gcconfig64-Release.appveyor.pri
+# TODO: set these without full path in the new archive
+- echo QMAKE_LEX=win_flex --wincompat >> src\gcconfig.pri
+- echo QMAKE_YACC=win_bison --file-prefix=y -t >> src\gcconfig.pri
+
 # Add debug console
 #- echo CONFIG+=console >> src\gcconfig.pri
 

From 4faac4969993e781100b6d14dcd0c44be238ed60 Mon Sep 17 00:00:00 2001
From: Florian Klink <flokli@flokli.de>
Date: Sun, 11 Oct 2020 18:41:48 +0200
Subject: [PATCH 6/6] ci: linux: install bison from focal

We can't simply bump whole CI to focal, as Ubuntu 16.04 is the
recommended platform to generate AppImage files.

See
https://github.com/GoldenCheetah/GoldenCheetah/pull/3590#issuecomment-706731402
for details.
---
 travis/linux/before_install.sh | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/travis/linux/before_install.sh b/travis/linux/before_install.sh
index 73c75352c9..62f28e01de 100755
--- a/travis/linux/before_install.sh
+++ b/travis/linux/before_install.sh
@@ -1,6 +1,10 @@
 #!/bin/bash
 set -ev
 
+# install Bison 3.5 from focal
+wget http://mirrors.kernel.org/ubuntu/pool/main/b/bison/bison_3.5.1+dfsg-1_amd64.deb
+sudo dpkg -i bison_3.5.1+dfsg-1_amd64.deb
+
 # Add recent Qt dependency ppa, update on a newer qt version.
 sudo add-apt-repository -y ppa:beineri/opt-qt-5.14.2-xenial
 sudo apt-get update -qq
